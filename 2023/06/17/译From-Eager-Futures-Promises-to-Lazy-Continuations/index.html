<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=2">
<meta name="theme-color" content="#222">
<meta name="generator" content="Hexo 6.3.0">
  <link rel="apple-touch-icon" sizes="180x180" href="/images/apple-touch-icon-next.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/images/favicon-32x32-next.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/images/favicon-16x16-next.png">
  <link rel="mask-icon" href="/images/logo.svg" color="#222">

<link rel="stylesheet" href="/css/main.css">


<link rel="stylesheet" href="/lib/font-awesome/css/font-awesome.min.css">

<script id="hexo-configurations">
    var NexT = window.NexT || {};
    var CONFIG = {"hostname":"example.com","root":"/","scheme":"Muse","version":"7.8.0","exturl":false,"sidebar":{"position":"left","display":"post","padding":18,"offset":12,"onmobile":false},"copycode":{"enable":false,"show_result":false,"style":null},"back2top":{"enable":true,"sidebar":false,"scrollpercent":false},"bookmark":{"enable":false,"color":"#222","save":"auto"},"fancybox":false,"mediumzoom":false,"lazyload":false,"pangu":false,"comments":{"style":"tabs","active":null,"storage":true,"lazyload":false,"nav":null},"algolia":{"hits":{"per_page":10},"labels":{"input_placeholder":"Search for Posts","hits_empty":"We didn't find any results for the search: ${query}","hits_stats":"${hits} results found in ${time} ms"}},"localsearch":{"enable":false,"trigger":"auto","top_n_per_article":1,"unescape":false,"preload":false},"motion":{"enable":true,"async":false,"transition":{"post_block":"fadeIn","post_header":"slideDownIn","post_body":"slideDownIn","coll_header":"slideLeftIn","sidebar":"slideUpIn"}}};
  </script>

  <meta name="description" content="ä»‹ç»è¯‘è€…ä¸€ç›´å¯¹æœ‰å…³coroutineå’Œexecutionçš„æ¦‚å¿µéå¸¸è¿·æ‹ï¼Œè¿‘æ¥å¸Œæœ›å°†å¯¹è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ å¿ƒå¾—ç®€å•åˆ†äº«ä¸€ä¸‹æå‡ä¸‹è‡ªå·±çš„ç†è§£ï¼Œé¢„è®¡ä¼šæœ‰5 6ç¯‡åšæ–‡äº§å‡ºï¼Œå…ˆä»¥è¿™ç¯‡CppConçš„ç¿»è¯‘èµ·ä¸ªå¤´ ä¸‹æ–‡ä¼šä»pdfçš„ç¬¬ä¸€ç« å¼€å§‹ç¿»è¯‘ motivating futures&#x2F;promises + actorså½“å·¥ç¨‹å¸ˆè¯•å›¾æ‰“é€ ä¸€æ¬¾é«˜æ€§èƒ½ä¸”æ­£ç¡®çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ä¼šé‡åˆ°è®¸å¤šå…³é”®æŒ‘æˆ˜ã€‚æ¦‚æ‹¬ä¸‹æ¥æœ‰ä¸¤æ¡  åœ¨ä»£ç ä¸­">
<meta property="og:type" content="article">
<meta property="og:title" content="è¯‘From Eager  Futures&#x2F;Promises  to Lazy Continuations">
<meta property="og:url" content="http://example.com/2023/06/17/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/index.html">
<meta property="og:site_name" content="Hexo">
<meta property="og:description" content="ä»‹ç»è¯‘è€…ä¸€ç›´å¯¹æœ‰å…³coroutineå’Œexecutionçš„æ¦‚å¿µéå¸¸è¿·æ‹ï¼Œè¿‘æ¥å¸Œæœ›å°†å¯¹è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ å¿ƒå¾—ç®€å•åˆ†äº«ä¸€ä¸‹æå‡ä¸‹è‡ªå·±çš„ç†è§£ï¼Œé¢„è®¡ä¼šæœ‰5 6ç¯‡åšæ–‡äº§å‡ºï¼Œå…ˆä»¥è¿™ç¯‡CppConçš„ç¿»è¯‘èµ·ä¸ªå¤´ ä¸‹æ–‡ä¼šä»pdfçš„ç¬¬ä¸€ç« å¼€å§‹ç¿»è¯‘ motivating futures&#x2F;promises + actorså½“å·¥ç¨‹å¸ˆè¯•å›¾æ‰“é€ ä¸€æ¬¾é«˜æ€§èƒ½ä¸”æ­£ç¡®çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ä¼šé‡åˆ°è®¸å¤šå…³é”®æŒ‘æˆ˜ã€‚æ¦‚æ‹¬ä¸‹æ¥æœ‰ä¸¤æ¡  åœ¨ä»£ç ä¸­">
<meta property="og:locale" content="en_US">
<meta property="og:image" content="http://example.com/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/actors%E4%BA%A4%E4%BA%92%E5%9B%BE.png">
<meta property="og:image" content="http://example.com/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/threads%E4%BA%A4%E4%BA%92%E5%9B%BE.png">
<meta property="article:published_time" content="2023-06-17T15:23:03.000Z">
<meta property="article:modified_time" content="2023-06-18T06:31:28.967Z">
<meta property="article:author" content="John Doe">
<meta name="twitter:card" content="summary">
<meta name="twitter:image" content="http://example.com/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/actors%E4%BA%A4%E4%BA%92%E5%9B%BE.png">

<link rel="canonical" href="http://example.com/2023/06/17/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/">


<script id="page-configurations">
  // https://hexo.io/docs/variables.html
  CONFIG.page = {
    sidebar: "",
    isHome : false,
    isPost : true,
    lang   : 'en'
  };
</script>

  <title>è¯‘From Eager  Futures/Promises  to Lazy Continuations | Hexo</title>
  






  <noscript>
  <style>
  .use-motion .brand,
  .use-motion .menu-item,
  .sidebar-inner,
  .use-motion .post-block,
  .use-motion .pagination,
  .use-motion .comments,
  .use-motion .post-header,
  .use-motion .post-body,
  .use-motion .collection-header { opacity: initial; }

  .use-motion .site-title,
  .use-motion .site-subtitle {
    opacity: initial;
    top: initial;
  }

  .use-motion .logo-line-before i { left: initial; }
  .use-motion .logo-line-after i { right: initial; }
  </style>
</noscript>

</head>

<body itemscope itemtype="http://schema.org/WebPage">
  <div class="container use-motion">
    <div class="headband"></div>

    <header class="header" itemscope itemtype="http://schema.org/WPHeader">
      <div class="header-inner"><div class="site-brand-container">
  <div class="site-nav-toggle">
    <div class="toggle" aria-label="Toggle navigation bar">
      <span class="toggle-line toggle-line-first"></span>
      <span class="toggle-line toggle-line-middle"></span>
      <span class="toggle-line toggle-line-last"></span>
    </div>
  </div>

  <div class="site-meta">

    <a href="/" class="brand" rel="start">
      <span class="logo-line-before"><i></i></span>
      <h1 class="site-title">Hexo</h1>
      <span class="logo-line-after"><i></i></span>
    </a>
  </div>

  <div class="site-nav-right">
    <div class="toggle popup-trigger">
    </div>
  </div>
</div>




<nav class="site-nav">
  <ul id="menu" class="menu">
        <li class="menu-item menu-item-home">

    <a href="/" rel="section"><i class="fa fa-fw fa-home"></i>Home</a>

  </li>
        <li class="menu-item menu-item-about">

    <a href="/about/" rel="section"><i class="fa fa-fw fa-about"></i>About</a>

  </li>
        <li class="menu-item menu-item-archives">

    <a href="/archives/" rel="section"><i class="fa fa-fw fa-archive"></i>Archives</a>

  </li>
  </ul>
</nav>




</div>
    </header>

    
  <div class="back-to-top">
    <i class="fa fa-arrow-up"></i>
    <span>0%</span>
  </div>


    <main class="main">
      <div class="main-inner">
        <div class="content-wrap">
          

          <div class="content post posts-expand">
            

    
  
  
  <article itemscope itemtype="http://schema.org/Article" class="post-block" lang="en">
    <link itemprop="mainEntityOfPage" href="http://example.com/2023/06/17/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/">

    <span hidden itemprop="author" itemscope itemtype="http://schema.org/Person">
      <meta itemprop="image" content="/images/avatar.gif">
      <meta itemprop="name" content="John Doe">
      <meta itemprop="description" content="">
    </span>

    <span hidden itemprop="publisher" itemscope itemtype="http://schema.org/Organization">
      <meta itemprop="name" content="Hexo">
    </span>
      <header class="post-header">
        <h1 class="post-title" itemprop="name headline">
          è¯‘From Eager  Futures/Promises  to Lazy Continuations
        </h1>

        <div class="post-meta">
            <span class="post-meta-item">
              <span class="post-meta-item-icon">
                <i class="fa fa-calendar-o"></i>
              </span>
              <span class="post-meta-item-text">Posted on</span>

              <time title="Created: 2023-06-17 23:23:03" itemprop="dateCreated datePublished" datetime="2023-06-17T23:23:03+08:00">2023-06-17</time>
            </span>
              <span class="post-meta-item">
                <span class="post-meta-item-icon">
                  <i class="fa fa-calendar-check-o"></i>
                </span>
                <span class="post-meta-item-text">Edited on</span>
                <time title="Modified: 2023-06-18 14:31:28" itemprop="dateModified" datetime="2023-06-18T14:31:28+08:00">2023-06-18</time>
              </span>

          

        </div>
      </header>

    
    
    
    <div class="post-body" itemprop="articleBody">

      
        <h2 id="ä»‹ç»"><a href="#ä»‹ç»" class="headerlink" title="ä»‹ç»"></a>ä»‹ç»</h2><p>è¯‘è€…ä¸€ç›´å¯¹æœ‰å…³coroutineå’Œexecutionçš„æ¦‚å¿µéå¸¸è¿·æ‹ï¼Œè¿‘æ¥å¸Œæœ›å°†å¯¹è¿™éƒ¨åˆ†å†…å®¹çš„å­¦ä¹ å¿ƒå¾—ç®€å•åˆ†äº«ä¸€ä¸‹æå‡ä¸‹è‡ªå·±çš„ç†è§£ï¼Œé¢„è®¡ä¼šæœ‰5 6ç¯‡åšæ–‡äº§å‡ºï¼Œå…ˆä»¥è¿™ç¯‡CppConçš„ç¿»è¯‘èµ·ä¸ªå¤´</p>
<p>ä¸‹æ–‡ä¼šä»pdfçš„ç¬¬ä¸€ç« å¼€å§‹ç¿»è¯‘</p>
<h2 id="motivating-futures-x2F-promises-actors"><a href="#motivating-futures-x2F-promises-actors" class="headerlink" title="motivating futures&#x2F;promises + actors"></a>motivating futures&#x2F;promises + actors</h2><p>å½“å·¥ç¨‹å¸ˆè¯•å›¾æ‰“é€ ä¸€æ¬¾é«˜æ€§èƒ½ä¸”æ­£ç¡®çš„åˆ†å¸ƒå¼ç³»ç»Ÿæ—¶ä¼šé‡åˆ°è®¸å¤šå…³é”®æŒ‘æˆ˜ã€‚æ¦‚æ‹¬ä¸‹æ¥æœ‰ä¸¤æ¡</p>
<ol>
<li>åœ¨ä»£ç ä¸­ä¸å¾—ä¸æœ‰ç­‰å¾…çš„æ¡ä»¶</li>
<li>åœ¨ä»£ç ä¸­æœ‰state</li>
</ol>
<h3 id="å¦‚ä½•è§£å†³ç­‰å¾…çš„é—®é¢˜"><a href="#å¦‚ä½•è§£å†³ç­‰å¾…çš„é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³ç­‰å¾…çš„é—®é¢˜"></a>å¦‚ä½•è§£å†³ç­‰å¾…çš„é—®é¢˜</h3><p>ä»¥ä¸‹é¢çš„ä»£ç ä¸ºä¾‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::string text=<span class="string">&quot;...&quot;</span>;</span><br><span class="line">text = <span class="built_in">SpellCehck</span>(text);</span><br><span class="line">text = <span class="built_in">GrammerCheck</span>(text);</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç å¯é€šè¿‡å‡½æ•°çš„ç»„åˆä¿®æ”¹æˆä¸€è¡Œ<code>GrammerCheck(SpellCehck(&quot;...&quot;))</code>. ä¸è¿‡æ¥ä¸‹æ¥æˆ‘ä»¬è¿˜æ˜¯åˆ†å¼€åˆ†æï¼Œå…ˆåˆ†æSpellCheckå‡½æ•°çš„å®ç°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">SpellCheck</span><span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> body = http::<span class="built_in">UrlEncode</span>(&#123;<span class="string">&quot;text&quot;</span>, text&#125;);</span><br><span class="line">  <span class="keyword">auto</span> response = http::<span class="built_in">Post</span>(<span class="string">&quot;https://www.online-spellcheck.com&quot;</span>, body);</span><br><span class="line">  <span class="keyword">return</span> response.body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>æ— è®ºè¿™æ®µä»£ç ä¹‹ä¸­çš„<code>Http::Post</code>æ–¹æ³•æ˜¯é˜»å¡çš„è¿˜æ˜¯éé˜»å¡éƒ½ä¸ä¼šæ”¹å˜ä¸€ä»¶äº‹å®ï¼šä½ çš„ä»£ç ä¸å¾—ä¸åœ¨è¿™é‡Œç­‰å¾…<br>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ol>
<li>å°±æ­»ç­‰. è¿™ä¸ªæ–¹æ¡ˆè‚¯å®šæ˜¯ä¸ä¼šé‡‡çº³çš„</li>
<li>ä½¿ç”¨çº¿ç¨‹. æˆæœ¬é«˜æ˜‚åŒæ—¶å¯¹æ­£ç¡®æ€§æ— ç›Š</li>
<li>ä½¿ç”¨coroutine. ä½œè€…å½“æ—¶æ˜¯09å¹´ è¿˜æ²¡æœ‰å¥½ç”¨çš„C++ coroutine</li>
<li>ä½¿ç”¨ä¸åŒçš„è¯­è¨€æ¯”å¦‚erlang æˆ–è€… æŠŠerlangå¸¦è¿›C++ä¹‹ä¸­</li>
<li>ä½¿ç”¨å›è°ƒå‡½æ•°ï¼Œä¹‹åä¼šè®¨è®ºè¿™ä¸ª</li>
<li>ä½¿ç”¨future&#x2F;promise</li>
</ol>
<p>æ¥ä¸‹æ¥æˆ‘ä»¬è®¨è®ºfuture&#x2F;promiseã€‚<br>future&#x2F;promiseå°±åƒbuffered channelä¸€æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">Promise&lt;std::string&gt; promise;</span><br><span class="line">---------------thread x-------------</span><br><span class="line">Channel::Reader&lt;std::string&gt; reader = channel.<span class="built_in">Reader</span>();</span><br><span class="line">reader.<span class="built_in">Read</span>(); <span class="comment">// Blocks!</span></span><br><span class="line">---------------thread y-------------</span><br><span class="line">Channel::Writer&lt;std::string&gt; writer = channel.<span class="built_in">Writer</span>();</span><br><span class="line">writer.<span class="built_in">Write</span>(<span class="string">&quot;...&quot;</span>); <span class="comment">// Non-blocking!</span></span><br><span class="line">writer.<span class="built_in">Close</span>();</span><br></pre></td></tr></table></figure>

<p>æ”¹ä¸ºfutureä»£ç å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">Promise&lt;std::string&gt; promise;</span><br><span class="line">---------------thread x-------------</span><br><span class="line">Future&lt;std::string&gt; future = promise.<span class="built_in">Future</span>();</span><br><span class="line">future.<span class="built_in">Get</span>(); <span class="comment">// Blocks!</span></span><br><span class="line">---------------thread y-------------</span><br><span class="line">promise.<span class="built_in">Set</span>(<span class="string">&quot;...&quot;</span>); <span class="comment">// Non-blocking!</span></span><br></pre></td></tr></table></figure>

<p>æ¥ä¸‹æ¥æˆ‘ä»¬ç”¨futureæ¥ä¿®æ”¹SpellCheckå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œæˆ‘ä»¬å¼‚æ­¥åœ°è¯·æ±‚Postæ–¹æ³•ï¼Œå¹¶é€šè¿‡futureæ‹¿åˆ°å¯¹åº”çš„è¿”å›å€¼</span></span><br><span class="line"><span class="function">Future&lt;std::string&gt; <span class="title">SpellCheck</span><span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> body = http::<span class="built_in">UrlEncode</span>(&#123;<span class="string">&quot;text&quot;</span>, text&#125;);</span><br><span class="line">  Promise&lt;std::string&gt; promise;</span><br><span class="line">  <span class="keyword">auto</span> future = promise.<span class="built_in">Future</span>();</span><br><span class="line">  http::<span class="built_in">AsyncPost</span>(</span><br><span class="line">      <span class="string">&quot;https://www.online-spellcheck.com&quot;</span> ,</span><br><span class="line">      body,</span><br><span class="line">      [promise = std::<span class="built_in">move</span>(promise)]( <span class="keyword">auto</span>&amp;&amp; response) &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.code != <span class="number">200</span>) promise.<span class="built_in">Fail</span>(response.code); </span><br><span class="line">        <span class="keyword">else</span> promise.<span class="built_in">Set</span>(response.body);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å‡å¦‚ç°åœ¨æˆ‘ä»¬çš„SpellCheckå’ŒGrammarCheckä¸¤ä¸ªå‡½æ•°éƒ½è¯•ç”¨äº†future&#x2F;promiseçš„æ–¹æ³•æ”¹é€ ï¼Œé‚£ä¹ˆæˆ‘ä»¬ä¼šç¢°åˆ°æ¥ä¸‹æ¥çš„é—®é¢˜</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">std::string text = <span class="string">&quot;...&quot;</span>; </span><br><span class="line">text = <span class="built_in">SpellCheck</span>(text). <span class="built_in">Get</span>(); <span class="comment">// Blocks!</span></span><br><span class="line">text = <span class="built_in">GrammarCheck</span>(text). <span class="built_in">Get</span>(); <span class="comment">// Blocks!</span></span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™ä¸¤ä¸ªæ–¹æ³•çš„Getéƒ½ä¼šæ˜¯é˜»å¡çš„ï¼Œé‚£ä¸ç›¸å½“äºæˆ‘ä»¬çš„ä»£ç åˆå˜æˆä¸²è¡Œé˜»å¡çš„äº†å—ï¼Ÿè¿™é‡Œçš„å‡½æ•°é€»è¾‘æ˜¯åœ¨å®Œæˆspellcheckåå†è°ƒç”¨grammarcheckï¼Œä¹Ÿå°±æ˜¯è¯´è¿™é‡Œçš„Control Flowåº”è¯¥æ˜¯<code>SpellCheck -&gt; GrammarCheck</code>é‚£ä¹ˆè¿™é‡Œå¦‚æœå¯ä»¥è®©ä¸¤ä¸ªfutureæ‹¥æœ‰future aå¼‚æ­¥æ‰§è¡Œå®Œäº†ä¹‹å(then)æ‰§è¡Œbçš„è¯­ä¹‰ä¼¼ä¹èƒ½é¿å…å¯¹åº”çš„é˜»å¡ï¼Œå‡è®¾C++çš„futureèƒ½æä¾›ç±»ä¼¼JavaScriptçš„<code>.then</code>æ¥å£ç»§ç»­è®¨è®ºè¿™ä¸ªé—®é¢˜.é‚£ä¹ˆå¯¹åº”ä»£ç æˆ–è®¸å¯ä»¥è¿™æ ·ä¿®æ”¹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// è¿™é‡Œå°†SpellCheckå’ŒGrammerCheckç»„åˆåˆ°ä¸€ä¸ªå‡½æ•°SpellAndGrammarCheckä¹‹ä¸­</span></span><br><span class="line"><span class="function">Future&lt;std::string&gt; <span class="title">SpellAndGrammarCheck</span> <span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">SpellCheck</span>(text)</span><br><span class="line">      .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; text) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GrammarCheck</span>(text);<span class="comment">// Can be a Future&lt;T&gt; or T.</span></span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>åˆ°è¿™é‡Œæˆ‘ä»¬ä¼¼ä¹è§£å†³äº†ç­‰å¾…çš„é—®é¢˜.</p>
<h3 id="å¦‚ä½•è§£å†³çŠ¶æ€çš„é—®é¢˜"><a href="#å¦‚ä½•è§£å†³çŠ¶æ€çš„é—®é¢˜" class="headerlink" title="å¦‚ä½•è§£å†³çŠ¶æ€çš„é—®é¢˜"></a>å¦‚ä½•è§£å†³çŠ¶æ€çš„é—®é¢˜</h3><p>ä½¿ç”¨future&#x2F;promisesæ‰§è¡Œä»£ç çš„ä¸€äº›æ€§è´¨</p>
<ul>
<li>å› ä¸ºä»£ç ä¸­ä»ä¸blockæ‰€ä»¥å¯ä»¥åªæœ‰ä¸€ä¸ªçº¿ç¨‹ä¾¿æ‰§è¡Œ(ç±»å‹JavaScriptçš„æ¨¡å‹ï¼Œåªæœ‰åŸºäºlibuvæä¾›çš„å•çº¿ç¨‹event loop)</li>
<li>ç„¶åä»£ç å¹¶ä¸ä¸€å®šèƒ½åŸå­åœ°æ‰§è¡Œï¼Œå› ä¸ºå½“ä»£ç ä¸­å‡ºç°å¿…é¡»ç­‰å¾…åˆ«çš„ä»£ç æ—¶å°±å‡ºç°äº†äº¤äº’(åœ¨ä¸å¾—ä¸ç­‰å¾…æ—¶ä¼šæœ‰åˆ«çš„ä»£ç è¢«æ‰§è¡Œå°±æ˜¯é—®é¢˜çš„å…³é”®)</li>
<li>è®¸å¤šäººç§°è¿™ç§æƒ…å†µä¸ºâ€concurrencyâ€ vs parallelismå› ä¸ºè¿™ç§æ¨¡å¼ç»™äº†ä½ å¹¶å‘æ‰§è¡Œçš„é”™è§‰ç„¶è€Œä½ å¹¶æ²¡æœ‰åŒæ—¶åœ¨æ‰§è¡Œ</li>
<li>ä½†æ˜¯ä½ ä¾æ—§å¾—å¿å—å¹¶å‘æ‰§è¡Œæ‰€å¸¦æ¥çš„åŒæ­¥é—®é¢˜</li>
<li>ä¹Ÿå¯ä»¥åŸºäºå¤šçº¿ç¨‹æ‰§è¡Œä»£ç </li>
</ul>
<p>å¯èƒ½çš„è§£å†³æ–¹æ¡ˆå¦‚ä¸‹ï¼š</p>
<ul>
<li>1963å¹´æå‡ºäº†mutexeså’Œsemaphore</li>
<li>1973å¹´æå‡ºäº†actors</li>
<li>1974å¹´æå‡ºäº†monitors</li>
<li>1978å¹´æå‡ºäº†communicating sequential processes</li>
<li>1987å¹´æå‡ºäº†statecharts</li>
</ul>
<p>å…¶ä¸­mutexesï¼Œsemaphoreså’Œmonitorséƒ½æ˜¯åŸºäºthreadsçš„è§£å†³æ–¹æ¡ˆ<br>è€Œactorsï¼Œcspï¼Œstatechartsæ˜¯æ²¡æœ‰çº¿ç¨‹çš„è§£å†³æ–¹æ¡ˆ</p>
<p>æ²¡æœ‰çº¿ç¨‹ä¼šæ˜¯ä»€ä¹ˆæƒ…å†µï¼Ÿ<br>æ²¡æœ‰çº¿ç¨‹çš„æŠ½è±¡åŒ…å«äº†æ‰§è¡Œæ¨¡å‹&#x2F;è¯­ä¹‰å’ŒçŠ¶æ€çš„åŒæ­¥<br>actorsåŒ…æ‹¬äº†æ‰§è¡Œï¼ŒåŒæ­¥ï¼ŒçŠ¶æ€</p>
<p>åŒ…æ‹¬å¾—æ›´å¤š -&gt; æ›´é«˜çº§çš„æŠ½è±¡èƒ½å¸¦æ¥</p>
<ul>
<li>æ›´å®¹æ˜“ç†è§£</li>
<li>æ›´å®¹æ˜“åœ¨æ›´å¤šçš„ç¡¬ä»¶å’Œå¹³å°è¿è¡Œ</li>
<li>æ›´å®¹æ˜“ä¼˜åŒ–</li>
</ul>
<p>actorsçš„æ€§è´¨</p>
<ul>
<li>æœ¬åœ°å¯ä¿®æ”¹çŠ¶æ€</li>
<li>æ¶ˆæ¯é˜Ÿåˆ—</li>
<li>ä¸€æ¬¡æ¥å—å¹¶å¤„ç†ä¸€æ¡æ¶ˆæ¯</li>
<li>actorsä¹‹é—´å‘é€æ¶ˆæ¯æ˜¯éé˜»å¡çš„</li>
<li>ä¸è®ºæ˜¯localè¿˜æ˜¯distributedæ¨¡å¼éƒ½æ˜¯åŒæ ·çš„ç¼–ç¨‹æ¨¡å‹</li>
</ul>
<p>ä¸‹é¢æˆ‘ä»¬çœ‹ä¸€æ®µåœ¨C++ä¸­çš„actoræ¨¡å‹çš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyActor</span> : <span class="keyword">public</span> Actor &#123;</span><br><span class="line">  <span class="function"><span class="type">void</span> <span class="title">Receive</span><span class="params">(ActorId sender, Message message, <span class="type">void</span>* arguments)</span> <span class="keyword">override</span> </span>&#123;</span><br><span class="line">    <span class="keyword">switch</span> (message) &#123;</span><br><span class="line">      <span class="keyword">case</span> MESSAGE_FOO_REQUEST:</span><br><span class="line">        <span class="keyword">auto</span>* request = (FooRequest*) arguments;</span><br><span class="line">        ...</span><br><span class="line">        <span class="built_in">Send</span>(sender, MESSAGE_FOO_RESPONSE, response);</span><br><span class="line">        <span class="keyword">break</span>;</span><br><span class="line">      <span class="keyword">case</span> MESSAGE_BAR_REQUEST:</span><br><span class="line">      ...</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>åªéœ€è¦å®ç°ä¸åŒçš„requestï¼Œactoråœ¨æ¥å—åˆ° messageåå°±èƒ½æ´¾å‘åˆ°å¯¹åº”çš„actorä¸Šå»ã€‚<br><img src="/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/actors%E4%BA%A4%E4%BA%92%E5%9B%BE.png" alt="actors (visualized)"></p>
<p>å¦‚æœå¯¹æ‰€æœ‰çš„æ–¹æ³•ä¸Šé”ï¼ˆç±»ä¼¼javaçš„synchronizedï¼‰èƒ½ä¸èƒ½åšåˆ°åŒæ ·çš„æ•ˆæœå‘¢ï¼Ÿ<br><img src="/%E8%AF%91From-Eager-Futures-Promises-to-Lazy-Continuations/threads%E4%BA%A4%E4%BA%92%E5%9B%BE.png" alt="threads (visualized)"></p>
<p>actorçš„æ€§èƒ½å¦‚ä½•ï¼Ÿ<br>å¯¹äºæ•°æ®ç»å¸¸éœ€è¦è¢«å…±äº«æˆ–è€…åœ¨æ‰§è¡Œèµ„æºé—´ç§»åŠ¨çš„å¹¶å‘ç¨‹åºæ²¡å•¥å½±å“</p>
<p>ä½†æ˜¯å¯¹äºåˆ†å¸ƒå¼å’Œç½‘ç»œç¨‹åºï¼Œæ•°æ®ç»å¸¸åªåœ¨åˆ«çš„æœºå™¨ä¸Šè¢«å…±äº«ï¼Œå¹¶ä¸”åœ¨ä»»æ„çš„coreä¹‹é—´äº¤æ¢æ•°æ®ä¼šå¸¦æ¥æ€§èƒ½ä¸‹é™</p>
<p>ä¼¼ä¹é€šè¿‡actoræˆ‘ä»¬è§£å†³äº†stateçš„é—®é¢˜</p>
<h2 id="libprocess"><a href="#libprocess" class="headerlink" title="libprocess"></a>libprocess</h2><p>ä½œè€…åœ¨2009å¹´çš„æ—¶å€™</p>
<ul>
<li>åœ¨UCB æ„å»ºåˆ†å¸ƒå¼ç³»ç»ŸApache Mesos</li>
<li>ä½¿ç”¨äº†C++æ¥é¿å…å¦‚Javaçš„gcè¯­è¨€ä¼šå¸¦æ¥çš„è¿è¡Œæ—¶ä¸ç¡®å®šæ€§é—®é¢˜</li>
<li>å¸Œæœ›ä½¿ç”¨actors</li>
</ul>
<p>äºæ˜¯åœ¨æ‰“é€ libprocessçš„æ—¶å€™ä»–ä»¬æƒ³åˆ°äº†å°†futures&#x2F;promiseså’Œactorsç»“åˆï¼</p>
<h3 id="ä¸ºä»€ä¹ˆactoréœ€è¦future-x2F-promises"><a href="#ä¸ºä»€ä¹ˆactoréœ€è¦future-x2F-promises" class="headerlink" title="ä¸ºä»€ä¹ˆactoréœ€è¦future&#x2F;promises"></a>ä¸ºä»€ä¹ˆactoréœ€è¦future&#x2F;promises</h3><p>å›é¦–ä¸Šé¢çš„actorä»£ç ä¼šå‘ç°å¾ˆéš¾æè¿°æ¸…æ¥šactorä¹‹é—´çš„æ‰§è¡Œæµ</p>
<ul>
<li>åœ¨actor æ¨¡å‹ä¸Šæ”¶å‘ä¿¡æ¯å°±å¦‚åŒç¼–å†™æ±‡ç¼–è¯­è¨€ä¸€æ ·ï¼ˆè¯‘è€…æ³¨ï¼šç¼–å†™éš¾åº¦å’Œä½“éªŒï¼‰å°½ç®¡ä»–ä»¬ç¡®å®è§£å†³äº†stateçš„é—®é¢˜</li>
<li>messageçš„å¤„ç†å°±å¦‚åŒgotoä¸€æ ·ï¼è€Œgotoæ˜¯éç»“æ„åŒ–çš„ï¼Œæ˜¯ä¸è¢«æå€¡çš„</li>
</ul>
<p>æŠ›å¼ƒgotoè¿™ä¸ªç©æ„ï¼Œæˆ‘ä»¬æƒ³è¦çš„æ˜¯</p>
<ul>
<li>éé˜»å¡çš„å‡½æ•°è°ƒç”¨(è¿”å›future)</li>
<li>å‡½æ•°çš„å¯ç»„åˆæ€§(Then)</li>
</ul>
<p>å°±åƒå¦‚ä¸‹çš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">MyActor actor;</span><br><span class="line"><span class="keyword">auto</span> future = actor.<span class="built_in">Foo</span>(...)</span><br><span class="line">  .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; response) &#123;</span><br><span class="line">    <span class="keyword">return</span> ...;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>libprocess actorçš„ä¼ªä»£ç å¦‚ä¸‹</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyActor</span> : <span class="keyword">public</span> Actor &#123;</span><br><span class="line">  <span class="function">Future&lt;FooResponse&gt; <span class="title">Foo</span><span class="params">(FooRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Execute the â€œmessageâ€ on the actor â€˜self()â€™.                                                                                                                </span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">On</span>(<span class="built_in">self</span>(), [<span class="keyword">this</span>, request]() &#123;</span><br><span class="line">      FooResponse response;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> response;</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>æ³¨æ„è¿™é‡ŒOn(self(), closure)çš„è¯­ä¹‰æ˜¯åœ¨self()ä¹Ÿå°±æ˜¯è¿™ä¸ªactorå®ä¾‹æœ¬èº«è¿™ä¸ªæ‰§è¡Œèµ„æºä¸Šæ‰§è¡Œclosureä¸­çš„å†…å®¹</p>
<p>è‡ªç„¶çš„ä¹Ÿå¯ä»¥åœ¨å‡½æ•°ä¸­é€šè¿‡thenç»„åˆè°ƒç”¨åˆ«çš„é€»è¾‘</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyActor</span> : <span class="keyword">public</span> Actor &#123;</span><br><span class="line">  <span class="function">Future&lt;FooResponse&gt; <span class="title">Foo</span><span class="params">(FooRequest request)</span> </span>&#123;</span><br><span class="line">    <span class="comment">// Execute the â€œmessageâ€ on the actor â€˜self()â€™.                                                                                                                </span></span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">On</span>(<span class="built_in">self</span>(), [<span class="keyword">this</span>, request]() &#123;</span><br><span class="line">      ...</span><br><span class="line">      <span class="keyword">return</span> <span class="built_in">SomeOtherFunctionReturningAFuture</span>()</span><br><span class="line">        .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; value) &#123;</span><br><span class="line">           ...</span><br><span class="line">        &#125;);</span><br><span class="line">    &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<h3 id="why-futures-x2F-promises-need-actors"><a href="#why-futures-x2F-promises-need-actors" class="headerlink" title="why futures&#x2F;promises need actors"></a>why futures&#x2F;promises need actors</h3><p>è§‚å¯Ÿä¸€ä¸‹ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyObject</span> &#123;</span><br><span class="line">  <span class="function">Future&lt;<span class="type">void</span>&gt; <span class="title">SomeMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SomeFunction</span>()</span><br><span class="line">      .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; value) &#123;</span><br><span class="line">        <span class="comment">// Where should this lambda run?????                                                                                                                   </span></span><br><span class="line">        ...</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p><code>Then</code>ä¹‹ä¸­çš„å‡½æ•°é€»è¾‘åº”è¯¥è¿è¡Œåœ¨ä»€ä¹ˆä¹‹ä¸Šå‘¢ï¼Ÿä¸€ä¸ªç®€å•çš„æƒ³æ³•æ˜¯ç›´æ¥ä½¿ç”¨<code>SomeFunction</code>è¿”å›çš„futureæ‰€å…³è”çš„promiseæ‰€åœ¨çš„æ‰§è¡Œèµ„æºä¹‹ä¸Š</p>
<p>å®Œå–„ä¸€ä¸‹ä¸Šé¢çš„ä»£ç å¯èƒ½ä¼šæ˜¯è¿™æ ·</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyObject</span> &#123;</span><br><span class="line">  <span class="function">Future&lt;<span class="type">void</span>&gt; <span class="title">SomeMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SomeFunction</span>()</span><br><span class="line">      .<span class="built_in">Then</span>([<span class="keyword">this</span>](<span class="keyword">auto</span>&amp;&amp; value) &#123;</span><br><span class="line">        <span class="comment">// Where should this lambda run?????                                                                                                                    </span></span><br><span class="line">        std::unique_lock&lt;std::mutex&gt; <span class="built_in">lock</span>(mutex_);</span><br><span class="line">        i += value;</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> i_;</span><br><span class="line">  std::mutex mutex_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™å¯èƒ½ä¼šå¸¦æ¥ä¸€ä¸ªé—®é¢˜ï¼šåœ¨SomeFunctionå¯¹åº”çš„promiseçš„æ‰§è¡Œé€»è¾‘åœ¨è°ƒç”¨<code>promise.Set()</code>çš„æ—¶å€™å¯èƒ½æ˜¯é˜»å¡çš„(å¯ä»¥ç†è§£æˆæ‰§è¡Œpromiseçš„é€»è¾‘å’Œæ‰§è¡ŒThençš„é€»è¾‘å¯èƒ½ä¼šå¹¶è¡Œï¼Œè¿™é‡Œå°±æœ‰é”ä¼šå¸¦æ¥çš„åŒæ­¥ä»£ä»·)<br>æˆ–è®¸å¯ä»¥ä½¿ç”¨asyncmutexè¯•å›¾è§£å†³è¿™ä¸ªé—®é¢˜</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyObject</span> &#123;</span><br><span class="line">  <span class="function">Future&lt;<span class="type">void</span>&gt; <span class="title">SomeMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SomeFunction</span>()</span><br><span class="line">      .<span class="built_in">Then</span>([<span class="keyword">this</span>](<span class="keyword">auto</span>&amp;&amp; value) &#123;</span><br><span class="line">        <span class="comment">// Where should this lambda run?????                                                                                                                    </span></span><br><span class="line">        <span class="keyword">return</span> mutex_.<span class="built_in">Acquire</span>()</span><br><span class="line">          .<span class="built_in">Then</span>([<span class="keyword">this</span>]() &#123;</span><br><span class="line">            i += value;</span><br><span class="line">            mutex_.<span class="built_in">Release</span>();</span><br><span class="line">          &#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> i_;</span><br><span class="line">  AsyncMutex mutex_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<p>è¿™é‡Œè°ƒç”¨<code>Release()</code>å°†è¦&#x2F;å¿…é¡»æ‰§è¡Œä¸€ä¸ªä¸ä¼šblockçš„waiterï¼Œè¿™ä¹Ÿå¯èƒ½å¸¦æ¥ä¸ç¡®å®šçš„æ‰§è¡Œã€‚</p>
<p>å¦‚æœèƒ½å¤Ÿä¿è¯<code>Then</code>çš„å†…å®¹ä¸¥æ ¼åœ¨actoræ‰§è¡Œå®Œ<code>SomeFunction()</code>ä¹‹åæ‰§è¡Œå°±èƒ½å¤Ÿé¿å…ä¸Šæ–‡ä¸­éç¡®å®šæ€§æ‰§è¡Œå¸¦æ¥çš„åŒæ­¥é—®é¢˜</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">struct</span> <span class="title class_">MyObject</span> : <span class="keyword">public</span> Actor &#123;</span><br><span class="line">  <span class="function">Future&lt;<span class="type">void</span>&gt; <span class="title">SomeMember</span><span class="params">()</span> </span>&#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SomeFunction</span>()</span><br><span class="line">      .<span class="built_in">Then</span>(<span class="built_in">DeferOn</span>(<span class="built_in">self</span>(), [<span class="keyword">this</span>](<span class="keyword">auto</span>&amp;&amp; value) &#123;  <span class="comment">// Thenä¹‹ä¸­çš„å†…å®¹ä¹‹åä¼šåœ¨åŒä¸€ä¸ªactorçš„æ‰§è¡Œèµ„æºä¸Šæ‰§è¡Œ</span></span><br><span class="line">        i_ += value;</span><br><span class="line">      &#125;));</span><br><span class="line">  &#125;</span><br><span class="line"> <span class="keyword">private</span>:</span><br><span class="line">  <span class="type">int</span> i_;</span><br><span class="line">&#125;;</span><br></pre></td></tr></table></figure>

<ul>
<li>ä¸Šé¢çš„æ–¹å¼ä¸­actoræä¾›äº†æ‰§è¡Œ<code>Then</code>(continuation)çš„executorèµ„æº</li>
<li>è®¾ç½®promiseéå¸¸å¿«æ˜¯éé˜»å¡çš„(DeferOnä¿è¯äº†åœ¨setä¹‹åæ‰ä¼šæ‰§è¡ŒThenä¹‹ä¸­çš„é€»è¾‘)</li>
<li>æ— éœ€åŒæ­¥</li>
</ul>
<h2 id="revisiting-the-problem"><a href="#revisiting-the-problem" class="headerlink" title="revisiting the problem"></a>revisiting the problem</h2><p>é‡æ–°çœ‹ä¸€ä¸‹SpellAndGrammerCheckå‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">SpellAndGrammarCheck</span><span class="params">(std::string text)</span> </span>&#123; </span><br><span class="line">  text = <span class="built_in">SpellCheck</span>(text);</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">GrammarCheck</span>(text);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™æ®µä»£ç æ˜¯é¡ºåºçš„ï¼Œéå¹¶è¡Œçš„ï¼Œå³ä½¿å¹¶å‘æ‰§è¡Œä¹Ÿæ²¡æœ‰çŠ¶æ€éœ€è¦åŒæ­¥<br>ä¿®æ”¹æˆFutureå’ŒThençš„æ–¹å¼</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Future&lt;std::string&gt; <span class="title">SpellAndGrammarCheck</span><span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">SpellCheck</span>(text)</span><br><span class="line">      .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; text) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GrammarCheck</span>(text);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>è¿™ä¹‹ä¸­ä¼šç”³è¯·é”å¹¶ä¸”éœ€è¦åŠ¨æ€åˆ†é…å†…å­˜</p>
<h3 id="æ˜¯ä»€ä¹ˆéœ€è¦ç”³è¯·é”ä»¥åŠåŠ¨æ€åˆ†é…å†…å­˜"><a href="#æ˜¯ä»€ä¹ˆéœ€è¦ç”³è¯·é”ä»¥åŠåŠ¨æ€åˆ†é…å†…å­˜" class="headerlink" title="æ˜¯ä»€ä¹ˆéœ€è¦ç”³è¯·é”ä»¥åŠåŠ¨æ€åˆ†é…å†…å­˜"></a>æ˜¯ä»€ä¹ˆéœ€è¦ç”³è¯·é”ä»¥åŠåŠ¨æ€åˆ†é…å†…å­˜</h3><p>æˆ‘ä»¬å…ˆå±•å¼€SpellCheckçš„é€»è¾‘</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">Future&lt;std::string&gt; <span class="title">SpellAndGrammarCheck</span> <span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  ...</span><br><span class="line">  <span class="keyword">auto</span> future = promise.<span class="built_in">future</span>();</span><br><span class="line">  http::<span class="built_in">AsyncPost</span>( <span class="comment">// Non-blocking! Returns immediately!</span></span><br><span class="line">      ...,</span><br><span class="line">      [promise = std::<span class="built_in">move</span>(promise)]( <span class="keyword">auto</span>&amp;&amp; response) &#123;</span><br><span class="line">        promise.<span class="built_in">Set</span>(response.body);</span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">return</span> future</span><br><span class="line">      .<span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; text) &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">GrammarCheck</span>(text);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¸Šé¢çš„ä»£ç ä¸­åœ¨<code>promise.Set(response.body)</code>ä¸continuationé€šè¿‡<code>.Then()</code>ç»„åˆä¹‹é—´å­˜åœ¨race, è¿™ä¸¤ä¸ªåŠ¨ä½œå¯èƒ½åœ¨åŒæ—¶å‘ç”Ÿï¼Œäºæ­¤æˆ‘ä»¬éœ€è¦é”æ¥åŒæ­¥. å¦å¤–promiseä¹Ÿå¯èƒ½åœ¨continuationè¢«ç»„åˆèµ·æ¥ä»¥å‰è®¾ç½®ï¼Œæ‰€ä»¥éœ€è¦åŠ¨æ€å†…å­˜åˆ†é….</p>
<p>æœ‰ä»€ä¹ˆåŠæ³•é¿å…é”ä»¥åŠè¿™ä¸€æ¬¡åŠ¨æ€å†…å­˜åˆ†é…å—ï¼Ÿ</p>
<h2 id="evolution-of-libprocess"><a href="#evolution-of-libprocess" class="headerlink" title="evolution of libprocess"></a>evolution of libprocess</h2><h3 id="é¿å…é”å¼€é”€"><a href="#é¿å…é”å¼€é”€" class="headerlink" title="é¿å…é”å¼€é”€"></a>é¿å…é”å¼€é”€</h3><p>ä¸Šé¢çš„é€»è¾‘ä¸­SpellCheckçš„futureçš„ç»„è£…(å°†GrammarCheckçš„é€»è¾‘ç»„åˆåœ¨ä¸€èµ·)å’Œpromiseçš„setæ“ä½œä¹‹é—´æ˜¯å¯èƒ½å¹¶è¡Œçš„ï¼Œæ‰€ä»¥éœ€è¦é”æ¥åŒæ­¥ï¼Œä½†å¦‚æœå°†ä»£ç çš„é€»è¾‘åšä¸€ä¸‹ç®€å•çš„ä¿®æ”¹ï¼Œä¿®æ”¹æˆSpellCheckä¸­AsyncPostçš„é€»è¾‘æ‰§è¡Œå®Œä¹‹åæ‰§è¡Œä¸€ä¸ªå›è°ƒå‡½æ•°å°±å¯ä»¥é¿å…é”çš„åŒæ­¥(ä¹Ÿå°±æ˜¯ä¿è¯äº†GrammerCheckçš„é€»è¾‘ä¸€å®šåœ¨SpellCheckä¹‹å)</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// fçš„é€»è¾‘å…¶å®å°±æ˜¯GrammerCheck</span></span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SpellCheck</span><span class="params">(std::string text, std::function&lt;<span class="type">void</span>(std::string)&gt; f)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> body = http::<span class="built_in">UrlEncode</span>(&#123;<span class="string">&quot;text&quot;</span>, text&#125;);</span><br><span class="line">  </span><br><span class="line">  http::<span class="built_in">AsyncPost</span>(</span><br><span class="line">      <span class="string">&quot;https://www.online-spellcheck.com&quot;</span> ,</span><br><span class="line">      body,</span><br><span class="line">      [f = std::<span class="built_in">move</span>(f)](<span class="keyword">auto</span>&amp;&amp; response) &#123;</span><br><span class="line">        <span class="built_in">f</span>(response.body); <span class="comment">// Invoke continuation without locks!</span></span><br><span class="line">      &#125;);</span><br><span class="line">  <span class="keyword">return</span> future;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ä¹Ÿå¯ä»¥ä¿®æ”¹æˆæ¨¡æ¿å‡½æ•°</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">SpellCheck</span><span class="params">(std::string text, K k)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> body = http::<span class="built_in">UrlEncode</span>(&#123;<span class="string">&quot;text&quot;</span>, text&#125;);</span><br><span class="line">  http::<span class="built_in">AsyncPost</span>(</span><br><span class="line">      <span class="string">&quot;https://www.online-spellcheck.com&quot;</span> ,</span><br><span class="line">      body,</span><br><span class="line">      [k = std::<span class="built_in">move</span>(k)](<span class="keyword">auto</span>&amp;&amp; response) &#123;</span><br><span class="line">        <span class="keyword">if</span> (response.code != <span class="number">200</span>)  k.<span class="built_in">Fail</span>(response.code); </span><br><span class="line">        <span class="keyword">else</span> k.<span class="built_in">Success</span>(response.body);</span><br><span class="line">      &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
<p>è¯‘è€…æ³¨ï¼šä½œè€…åœ¨æ¼”è®²é‡Œè¡¨ç¤ºåœ¨ä»–è¯»å¤§å­¦çš„æ—¶å€™ä»–ä»¬éƒ½ç”¨Kæ¥è¡¨ç¤ºcontinuationï¼Œæ‰€ä»¥è¿™é‡Œæ¨¡æ¿é‡Œä»–ä¹Ÿç”¨çš„æ˜¯Kè€Œä¸æ˜¯C</p>
<h3 id="é¿å…åŠ¨æ€å†…å­˜åˆ†é…"><a href="#é¿å…åŠ¨æ€å†…å­˜åˆ†é…" class="headerlink" title="é¿å…åŠ¨æ€å†…å­˜åˆ†é…"></a>é¿å…åŠ¨æ€å†…å­˜åˆ†é…</h3><p>ä»¥ä¸Šé¢çš„æ¨¡æ¿å‡½æ•°ä¸ºä¾‹,åˆ°åº•æ˜¯åœ¨ä»€ä¹ˆåœ°æ–¹åˆ†é…äº†å†…å­˜å‘¢ï¼Ÿè¿™é‡Œéœ€è¦è¿›å…¥Http::AsyncPostçš„å®ç°ä¹‹ä¸­</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">namespace</span> http &#123;</span><br><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Post</span><span class="params">(std::string url, std::string body, K k)</span> </span>&#123;</span><br><span class="line">  <span class="type">void</span>* data = <span class="keyword">new</span> <span class="built_in">K</span>(std::<span class="built_in">move</span>(k));</span><br><span class="line">  ...</span><br><span class="line">  <span class="built_in">http_post</span>(url, body, data, +[](<span class="type">long</span> code, <span class="type">const</span> <span class="type">char</span>* body, <span class="type">void</span>* data) &#123;</span><br><span class="line">    K* k = <span class="built_in">reinterpret_cast</span>&lt;K*&gt;(data);</span><br><span class="line">    k-&gt;<span class="built_in">Success</span>(http::Response&#123;code, body&#125;);</span><br><span class="line">    <span class="keyword">delete</span> k;</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br><span class="line">&#125; <span class="comment">// namespace http</span></span><br></pre></td></tr></table></figure>

<p>åœ¨Postæ–¹æ³•ä¸­è¿˜æ˜¯åˆ†é…äº†å†…å­˜.</p>
<p>ğŸ’¡ å¦‚æœå°†continuation Kä½œä¸ºå‡½æ•°è¿”å›çš„ç»“æœä¸­çš„ä¸€éƒ¨åˆ†æ˜¯ä¸æ˜¯å°±é¿å…äº†åˆ†é…ï¼Ÿ</p>
<p>æ¥å—ä¸€ä¸ªcontinuationä½œä¸ºå‚æ•°å¹¶è¿”å›ä¸€ä¸ªcontinuationä½œä¸ºç»“æœ(è¿”å›å€¼ä¸­ç»„åˆ&#x2F;åŒ…æ‹¬äº†ä½œä¸ºå‚æ•°ä¼ é€’çš„continuation)</p>
<p>ä¿®æ”¹ä¸€ä¸‹ä¸Šé¢çš„Postæ–¹æ³•çš„å®ç°ï¼Œä¸å…¶åœ¨å‡½æ•°çš„æ ˆä¸Šåˆ†é…ä¸€ä¸ªå †ä¸Šçš„void*ï¼Œä¸å¦‚åœ¨å‡½æ•°ä¸­å®šä¹‰ä¸€ä¸ªä»…å­˜åœ¨äºè¯¥å‡½æ•°çš„structå¹¶è¿”å›ä¸€ä¸ªè¯¥structçš„å€¼</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">template</span> &lt;<span class="keyword">typename</span> K&gt;</span><br><span class="line"><span class="function"><span class="type">void</span> <span class="title">Post</span><span class="params">(std::string url, std::string body, K k)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">struct</span> <span class="title class_">Continuation</span> &#123;</span><br><span class="line">    <span class="function"><span class="type">void</span> <span class="title">Start</span><span class="params">()</span> </span>&#123;</span><br><span class="line">      <span class="type">void</span>* data = &amp;k;</span><br><span class="line">      <span class="built_in">http_post</span>(url, body, data, +[]( <span class="type">long</span> code, <span class="type">const</span> <span class="type">char</span>* body, <span class="type">void</span>* data) </span><br><span class="line">      &#123;</span><br><span class="line">        K* k = <span class="built_in">reinterpret_cast</span>&lt;K*&gt;(data);</span><br><span class="line">        k-&gt;<span class="built_in">Success</span>( http::Response&#123;code, body&#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">    std::string url, body;</span><br><span class="line">    K k;</span><br><span class="line">  &#125;;</span><br><span class="line">  <span class="keyword">return</span> Continuation&#123;std::<span class="built_in">move</span>(url), std::<span class="built_in">move</span>(body), std::<span class="built_in">move</span>(k)&#125;;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¯ä»¥çœ‹åˆ°è¿™æ®µä»£ç è®²ä¼ é€’è¿›å…¥çš„url,body,kéƒ½ä¼ é€’è¿›äº†struct Continuationä¹‹ä¸­ï¼Œä¹‹åè¿™ä¸‰ä¸ªå€¼çš„ç”Ÿå‘½å‘¨æœŸå°†åŒè¿”å›çš„Continuation valueç»‘å®šï¼Œåœ¨valueææ„æ—¶ä¸€åŒå›æ”¶ï¼ŒåŒæ—¶è¿™é‡Œçš„å†…å­˜åˆ†é…ä¹Ÿåªæœ‰ä¸€ä¸ªæ ˆä¸Šçš„å€¼ç±»å‹Continuationçš„å†…å­˜åˆ†é….</p>
<h3 id="lazy-continuation"><a href="#lazy-continuation" class="headerlink" title="lazy continuation"></a>lazy continuation</h3><figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">auto</span> k = http::<span class="built_in">Post</span>(url, body, <span class="comment">/* k&#x27; */</span>);</span><br><span class="line">k.<span class="built_in">Start</span>();</span><br></pre></td></tr></table></figure>

<ul>
<li>è¿”å›å€¼ç±»å‹æ˜¯â€computational graphâ€</li>
<li>è¿™ä¸ªgraphæ˜¯lazyçš„,å½“æˆ‘ä»¬æ‹¿åˆ°è¿™ä¸ªgraphæ—¶ä»€ä¹ˆéƒ½ä¸ä¼šå‘ç”Ÿ(tradeoff for dynamic allocation) å¹¶ä¸”å¦‚æœæˆ‘ä»¬æƒ³æ‰§è¡Œä»–çš„é€»è¾‘å°±å¿…é¡»æ˜¾å¼è°ƒç”¨start</li>
<li>graphå¯ä»¥åˆ†é…åœ¨æ ˆä¸Šæˆ–è€…å †ä¸Š</li>
<li>åœ¨å®Œæˆä»¥å‰å†…å­˜å¿…é¡»æœ‰æ•ˆ</li>
</ul>
<h2 id="eventuals"><a href="#eventuals" class="headerlink" title="eventuals"></a>eventuals</h2><p>ä½œè€…å°†lazy continuationç§°ä¸ºeventuals.</p>
<p>è¿™ä¸€ç« çš„å†…å®¹ä¸»è¦æ˜¯ä»‹ç»äº†eventualså¹¶ä¸”é€šè¿‡eventualså°†ä¸Šæ–‡ä¸­ä¼ é€’continuationçš„ä»£ç é£æ ¼è¿›è¡Œäº†ä¿®æ­£(ä¼ é€’continuationçœ‹ç€æ¯”è¾ƒéš¾çœ‹ä¸ç¬¦åˆäººä½“å·¥ç¨‹å­¦),è¯‘æ–‡ä¼šå¿½ç•¥è¿™éƒ¨åˆ†æ¨å¯¼,æ„Ÿå…´è¶£çš„è¯»è€…å¯ä»¥è®¿é—®<a target="_blank" rel="noopener" href="https://github.com/3rdparty/eventuals">eventuals</a>æŸ¥çœ‹è¿™ä¸ªé¡¹ç›®çš„ä¿¡æ¯.</p>
<h2 id="scheduling"><a href="#scheduling" class="headerlink" title="scheduling"></a>scheduling</h2><p>æœ¬ç« èŠ‚ä¸»è¦æ˜¯æ¢è®¨continuationåº”è¯¥åœ¨ä»€ä¹ˆåœ°æ–¹è¿è¡Œï¼Ÿå›æœ›ä¸‹é¢è¿™æ®µä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">Post</span><span class="params">(std::string url, std::string body)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> <span class="built_in">Eventual</span>&lt;http::Response&gt;([url, body]( <span class="keyword">auto</span>&amp; k) &#123;</span><br><span class="line">      <span class="keyword">using</span> K = std::<span class="type">decay_t</span>&lt;<span class="keyword">decltype</span>(k)&gt;;</span><br><span class="line">      <span class="type">void</span>* data = &amp;k;</span><br><span class="line">      <span class="built_in">http_post</span>(url, body, data, +[]( <span class="type">long</span> code, <span class="type">const</span> <span class="type">char</span>* body, <span class="type">void</span>* data) </span><br><span class="line">      &#123;</span><br><span class="line">        K* k = <span class="built_in">reinterpret_cast</span>&lt;K*&gt;(data);</span><br><span class="line">        k-&gt;<span class="built_in">Success</span>(http::Response&#123;code, body&#125;);</span><br><span class="line">      &#125;);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;);</span><br></pre></td></tr></table></figure>

<p>å¦‚æœcontinuationæ˜¯åœ¨event loopä¸­è¢«è°ƒç”¨çš„,æˆ‘ä»¬ä¸å¸Œæœ›continuationç»§ç»­åœ¨event loopä¸­ç»§ç»­è¿è¡Œ(ä¼šé˜»å¡å…¶ä»–çš„IOä»»åŠ¡,IOçº¿ç¨‹æ± ä¸åº”è¯¥æ‰§è¡Œå¤ªå¤æ‚çš„continuationä»»åŠ¡)<br>åŒç†,å¦‚æœcontinuationæ˜¯åœ¨actorä¸­è¢«è°ƒç”¨çš„æˆ‘ä»¬ä¹Ÿä¸å¸Œæœ›ç»§ç»­åœ¨actorçš„æ‰§è¡Œèµ„æºä¸Šè¿è¡Œï¼Œå› ä¸ºè¿™æ ·ä¼šé˜»å¡åˆ«çš„messageçš„å¤„ç†</p>
<p>å›é¦–çœ‹ä¸€ä¸‹motivating exempleçš„ä»£ç </p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="function">std::string <span class="title">SpellCheck</span><span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">auto</span> body = http::<span class="built_in">UrlEncode</span>(&#123;<span class="string">&quot;text&quot;</span>, text&#125;);</span><br><span class="line">  <span class="keyword">auto</span> response = http::<span class="built_in">Post</span>(<span class="string">&quot;https://www.online-spellcheck.com&quot;</span>, body);</span><br><span class="line">  <span class="keyword">return</span> response.body;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>å¾—ç›Šäºå‡½æ•°çš„æŠ½è±¡ï¼Œæˆ‘ä»¬å¯ä»¥åˆ†å¼€è€ƒè™‘å‡½æ•°çš„æ¥å£ä»¥åŠå®ç°.åœ¨è¿™é‡Œä¸éœ€è¦è€ƒè™‘http::Poståˆ°åº•æ˜¯å¦‚ä½•å®ç°çš„.</p>
<ul>
<li>æˆ‘ä»¬ä¸å…³å¿ƒæ˜¯å¦åœ¨å¤šçº¿ç¨‹ä¸Šå®ç°</li>
<li>æˆ‘ä»¬ä¸å…³å¿ƒæ˜¯å¦åœ¨GPUä¸Šå®ç°</li>
<li>æˆ‘ä»¬ä¸å…³å¿ƒæ˜¯å¦åœ¨FPGAä¸Šå®ç°</li>
</ul>
<p>ç„¶è€Œï¼Œå¦‚æœæ‰§è¡Œå®Œhttp::Postæ–¹æ³•å¹¶å°†æ§åˆ¶æµè¿”å›æ—¶æˆ‘ä»¬å‘ç°ç°åœ¨æ­£åœ¨</p>
<ul>
<li>äºæˆ‘ä»¬å¼€å§‹æ‰§è¡Œæ—¶ä¸åŒçš„çº¿ç¨‹ä¸Šæ‰§è¡Œæ—¶ï¼Œæˆ‘ä»¬ä¼šå¾ˆæƒŠè®¶</li>
<li>ä¸€å—GPUçš„æ‰§è¡Œé€»è¾‘ä¸Šï¼Œè€Œæˆ‘ä»¬æ˜¯åœ¨CPUä¸Šå¼€å§‹æ‰§è¡Œçš„ï¼Œæˆ‘ä»¬ä¼šå¾ˆæƒŠè®¶</li>
</ul>
<p>æ‰€ä»¥æˆ‘ä»¬åˆ°åº•åº”è¯¥è®©continuationåœ¨ä»€ä¹ˆåœ°æ–¹æ‰§è¡Œå‘¢ï¼Ÿ<br><strong>ä½¿ç”¨åœ¨ä½ ä¸å¾—ä¸ç­‰å¾…ä»¥å‰æ­£åœ¨ä½¿ç”¨çš„æ‰§è¡Œèµ„æº</strong></p>
<p>å¦åˆ™(è¯‘è€…æ³¨ï¼šè¿™é‡Œä½œè€…æ„æ€å¤§æ¦‚å°±æ˜¯å¦åˆ™æˆ‘ä»¬æ¯ä¸€æ¬¡éƒ½åº”è¯¥æ£€æŸ¥æ¥ä¸‹æ¥çš„å‡½æ•°è°ƒç”¨çš„æ–‡æ¡£&#x2F;å®ç°å»æŸ¥çœ‹å¯¹åº”çš„å‡½æ•°ä¼šä¸ä¼šåœ¨eventloopä¸Šæ‰§è¡Œï¼Œå¦‚æœæ˜¯çš„è¯å°±éœ€è¦è‡ªå·±é€šè¿‡ThreadPool::Scheduleç­‰æ–¹æ³•é‡æ–°è°ƒåº¦),éœ€è¦å°†ä»£ç è¿›è¡Œç±»ä¼¼çš„ä¿®æ”¹.</p>
<figure class="highlight c++"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">auto</span> <span class="title">SpellAndGrammarCheck</span> <span class="params">(std::string text)</span> </span>&#123;</span><br><span class="line">  <span class="keyword">return</span> ThreadPool::<span class="built_in">Schedule</span>([text]() &#123;</span><br><span class="line">    <span class="keyword">return</span> <span class="built_in">SpellCheck</span>(text)</span><br><span class="line">        <span class="comment">// Rescheduling on thread pool because we looked at  </span></span><br><span class="line">        <span class="comment">// documentation of &#x27;SpellCheck()&#x27; and it continues on the</span></span><br><span class="line">        <span class="comment">// event loop which we don&#x27;t want to be on.</span></span><br><span class="line">        | ThreadPool::<span class="built_in">Schedule</span>([text]() &#123;</span><br><span class="line">             <span class="keyword">return</span> <span class="built_in">Then</span>([](<span class="keyword">auto</span>&amp;&amp; text) &#123;</span><br><span class="line">               <span class="keyword">return</span> <span class="built_in">GrammarCheck</span>(text);</span><br><span class="line">             &#125;);</span><br><span class="line">           &#125;);</span><br><span class="line">  &#125;);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>ç±»ä¼¼çš„å†…å®¹å¯ä»¥æŸ¥çœ‹std::executionçš„ææ¡ˆ(è¯‘è€…åç»­çš„åšæ–‡ä¹Ÿä¼šä»‹ç»è¿™ä¸ªææ¡ˆ).</p>
<p>å¦å¤–ä¹Ÿä»‹ç»äº†åœ¨PLDIä¹Ÿæœ‰ç±»ä¼¼çš„å·¥ä½œ</p>
<p>â€œComposing Sorfware Efficiently with Litheâ€(PLDI 2010)</p>
<ul>
<li>å…è®¸è®¸å¤šåŒæ—¶çš„schedulerè´Ÿè´£è®¡ç®—å›¾çš„å­æ ‘</li>
<li>æ‰€æœ‰çš„è®¡ç®—éƒ½æ‹¥æœ‰ä¸€ä¸ªè°ƒåº¦context</li>
<li>å¯¹äºå†²æ´—æäº¤ä»»åŠ¡ç»™æ‹¥æœ‰contextçš„æ¥å£æä¾›äº†æ­£å¼çš„æ¥å£</li>
</ul>

    </div>

    
    
    

      <footer class="post-footer">

        


        
    <div class="post-nav">
      <div class="post-nav-item">
    <a href="/2023/06/17/post-title-with-whitespace/" rel="prev" title="post title with whitespace">
      <i class="fa fa-chevron-left"></i> post title with whitespace
    </a></div>
      <div class="post-nav-item">
    <a href="/2023/06/24/%E6%B5%85%E8%B0%88%E5%8D%8F%E7%A8%8B/" rel="next" title="æµ…è°ˆåç¨‹">
      æµ…è°ˆåç¨‹ <i class="fa fa-chevron-right"></i>
    </a></div>
    </div>
      </footer>
    
  </article>
  
  
  



          </div>
          

<script>
  window.addEventListener('tabs:register', () => {
    let { activeClass } = CONFIG.comments;
    if (CONFIG.comments.storage) {
      activeClass = localStorage.getItem('comments_active') || activeClass;
    }
    if (activeClass) {
      let activeTab = document.querySelector(`a[href="#comment-${activeClass}"]`);
      if (activeTab) {
        activeTab.click();
      }
    }
  });
  if (CONFIG.comments.storage) {
    window.addEventListener('tabs:click', event => {
      if (!event.target.matches('.tabs-comment .tab-content .tab-pane')) return;
      let commentClass = event.target.classList[1];
      localStorage.setItem('comments_active', commentClass);
    });
  }
</script>

        </div>
          
  
  <div class="toggle sidebar-toggle">
    <span class="toggle-line toggle-line-first"></span>
    <span class="toggle-line toggle-line-middle"></span>
    <span class="toggle-line toggle-line-last"></span>
  </div>

  <aside class="sidebar">
    <div class="sidebar-inner">

      <ul class="sidebar-nav motion-element">
        <li class="sidebar-nav-toc">
          Table of Contents
        </li>
        <li class="sidebar-nav-overview">
          Overview
        </li>
      </ul>

      <!--noindex-->
      <div class="post-toc-wrap sidebar-panel">
          <div class="post-toc motion-element"><ol class="nav"><li class="nav-item nav-level-2"><a class="nav-link" href="#%E4%BB%8B%E7%BB%8D"><span class="nav-number">1.</span> <span class="nav-text">ä»‹ç»</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#motivating-futures-x2F-promises-actors"><span class="nav-number">2.</span> <span class="nav-text">motivating futures&#x2F;promises + actors</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%AD%89%E5%BE%85%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.1.</span> <span class="nav-text">å¦‚ä½•è§£å†³ç­‰å¾…çš„é—®é¢˜</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E5%A6%82%E4%BD%95%E8%A7%A3%E5%86%B3%E7%8A%B6%E6%80%81%E7%9A%84%E9%97%AE%E9%A2%98"><span class="nav-number">2.2.</span> <span class="nav-text">å¦‚ä½•è§£å†³çŠ¶æ€çš„é—®é¢˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#libprocess"><span class="nav-number">3.</span> <span class="nav-text">libprocess</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E4%B8%BA%E4%BB%80%E4%B9%88actor%E9%9C%80%E8%A6%81future-x2F-promises"><span class="nav-number">3.1.</span> <span class="nav-text">ä¸ºä»€ä¹ˆactoréœ€è¦future&#x2F;promises</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#why-futures-x2F-promises-need-actors"><span class="nav-number">3.2.</span> <span class="nav-text">why futures&#x2F;promises need actors</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#revisiting-the-problem"><span class="nav-number">4.</span> <span class="nav-text">revisiting the problem</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E6%98%AF%E4%BB%80%E4%B9%88%E9%9C%80%E8%A6%81%E7%94%B3%E8%AF%B7%E9%94%81%E4%BB%A5%E5%8F%8A%E5%8A%A8%E6%80%81%E5%88%86%E9%85%8D%E5%86%85%E5%AD%98"><span class="nav-number">4.1.</span> <span class="nav-text">æ˜¯ä»€ä¹ˆéœ€è¦ç”³è¯·é”ä»¥åŠåŠ¨æ€åˆ†é…å†…å­˜</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#evolution-of-libprocess"><span class="nav-number">5.</span> <span class="nav-text">evolution of libprocess</span></a><ol class="nav-child"><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E9%94%81%E5%BC%80%E9%94%80"><span class="nav-number">5.1.</span> <span class="nav-text">é¿å…é”å¼€é”€</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#%E9%81%BF%E5%85%8D%E5%8A%A8%E6%80%81%E5%86%85%E5%AD%98%E5%88%86%E9%85%8D"><span class="nav-number">5.2.</span> <span class="nav-text">é¿å…åŠ¨æ€å†…å­˜åˆ†é…</span></a></li><li class="nav-item nav-level-3"><a class="nav-link" href="#lazy-continuation"><span class="nav-number">5.3.</span> <span class="nav-text">lazy continuation</span></a></li></ol></li><li class="nav-item nav-level-2"><a class="nav-link" href="#eventuals"><span class="nav-number">6.</span> <span class="nav-text">eventuals</span></a></li><li class="nav-item nav-level-2"><a class="nav-link" href="#scheduling"><span class="nav-number">7.</span> <span class="nav-text">scheduling</span></a></li></ol></div>
      </div>
      <!--/noindex-->

      <div class="site-overview-wrap sidebar-panel">
        <div class="site-author motion-element" itemprop="author" itemscope itemtype="http://schema.org/Person">
  <p class="site-author-name" itemprop="name">John Doe</p>
  <div class="site-description" itemprop="description"></div>
</div>
<div class="site-state-wrap motion-element">
  <nav class="site-state">
      <div class="site-state-item site-state-posts">
          <a href="/archives/">
        
          <span class="site-state-item-count">4</span>
          <span class="site-state-item-name">posts</span>
        </a>
      </div>
  </nav>
</div>



      </div>

    </div>
  </aside>
  <div id="sidebar-dimmer"></div>


      </div>
    </main>

    <footer class="footer">
      <div class="footer-inner">
        

        

<div class="copyright">
  
  &copy; 
  <span itemprop="copyrightYear">2023</span>
  <span class="with-love">
    <i class="fa fa-user"></i>
  </span>
  <span class="author" itemprop="copyrightHolder">John Doe</span>
</div>
  <div class="powered-by">Powered by <a href="https://hexo.io/" class="theme-link" rel="noopener" target="_blank">Hexo</a> & <a href="https://muse.theme-next.org/" class="theme-link" rel="noopener" target="_blank">NexT.Muse</a>
  </div>

        








      </div>
    </footer>
  </div>

  
  <script src="/lib/anime.min.js"></script>
  <script src="/lib/velocity/velocity.min.js"></script>
  <script src="/lib/velocity/velocity.ui.min.js"></script>

<script src="/js/utils.js"></script>

<script src="/js/motion.js"></script>


<script src="/js/schemes/muse.js"></script>


<script src="/js/next-boot.js"></script>




  















  

  

</body>
</html>
